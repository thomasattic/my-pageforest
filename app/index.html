<!DOCTYPE html>
<html >
  <head>
  <title>Welcome to Pageforest</title>
  <link rel="icon" type="image/png" href="/images/icon.png" />
  <link rel="apple-touch-icon" href="/images/touch.png" />

  <link rel="stylesheet" type="text/css" href="/lib/beta/css/client.css" />
  <style type="text/css" media="screen">@import "./jslib/jqtouch/jqtouch/jqtouch.css";</style>
  <style type="text/css" media="screen">@import "./jslib/jqtouch/themes/apple/theme.css";</style>
  <style type="text/css" media="screen">
    html, body {
       min-height: 100%;
    }

    body {
       -webkit-box-shadow: inset 1px 1px 10px rgba(127, 127, 127, 0.75);
       background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #AAA), color-stop(0.5, #999), color-stop(0.5, #999), color-stop(1, #666));
       background-image: -moz-linear-gradient(top, #AAA, #999 50%, #999 50%, #666);
       background-repeat: repeat-x;
       background-color: darkgrey;
    }

    #jqt > div#z-launcherpane, #jqt > form, #jqt > div {
       background-image: none;
       background-color: transparent;
    }

    #jqt > #z-launcherpane ul.grid {
       display: block;
       background-image: none;
       background-colo: transparent;
    }

    #jqt > #z-launcherpane ul.grid li {
       display: block;
       float: left;
    }
    #jqt > #z-launcherpane ul.grid li > a {
      display: block;
    }

    #jqt > #z-launcherpane ul.grid li .icon {
       background-color: #EEE;
    }

    @media only screen and (min-device-width: 768px) {
      #jqt > #z-launcherpane ul.grid li .icon {
         width: 64px;
         height: 64px;
      }
      #jqt > #z-launcherpane ul.grid li {
         margin: 30px;
      }
      #jqt > #z-launcherpane ul.grid li .icon .mask {
         background-image: -webkit-gradient(radial, 50% -58%, 35, 50% -35%, 190, from(rgba(255, 255, 255, 0.347656)), color-stop(0.03, rgba(255, 255, 255, 0.296875)), color-stop(0.22, rgba(239, 239, 239, 0)), color-stop(0.22, rgba(31, 31, 31, 0.199219)), color-stop(0.35, rgba(127, 127, 127, 0.0976563)), color-stop(0.38, rgba(239, 239, 239, 0.0976563)), to(rgba(255, 255, 255, 0)));
      }
    }

    #jqt:not(.initstate) .showoninit {
       display: none;
    }

    #jqt:not(.nouserstate) .showonnouser {
       display: none;
    }

    #pfSave {
       display: none;
    }

    #jqt .emboss {
      display: block; position: relative;
      -webkit-box-sizing: border-box;
      width: 100%; line-height: 20px;
      padding: 15px; padding-top: 20% !important;
      border-top: 1px solid rgba(76, 86, 108, .3);
      color: rgb(76, 76, 76);
      font-size: 16px; font-weight: bold; text-shadow: rgba(255,255,255,.8) 0 1px 0;
      text-align: center;
    }

  </style>

  <!--
     These scripts provide access to the standard Client library
     for Pageforest apps.  jQuery and JSON, are also required
     by the Client library.

     Note that the "beta" versions of the library are used.  These
     are the most up to date versions.  You can change "beta" to
     "0.6" if you want the latest frozen version of the libraries.

     API reference: http://code.google.com/p/pageforest/wiki/ClientLibrary
    -->

  <script src="/lib/beta/js/pf-client.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/lib/date.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/lib/json2.js" type="text/javascript" charset="utf-8"></script>
  <script src="./jslib/lib/jquery.jsonp-2.1.4.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="./jslib/lib/jquery.tmpl.min.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/beedesk/utilities.js" type="application/x-javascript" charset="utf-8"></script>

  <script src="./jslib/jqtouch/jqtouch/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/jqtouch/extensions/iscroll/iscroll.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/touchlayer/src/gestures.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/beedesk/jqt.js" type="application/x-javascript" charset="utf-8"></script>

  <!-- The scratch application code is in main.js -->
  <script src="main.js" type="text/javascript"></script>

  <script type="text/javascript">
    // Call the onReady function of the application when the page is loaded.
    var my = namespace.lookup("com.pageforest.my");

    $(document).ready(my.onReady);

    var referers;

    var documentreadysignal = Threads.latchbinder();
    my.documentready.push(documentreadysignal.latch);

    var loggedin;
    my.loggedin.push(function() {
      loggedin = true;
    });

    function addApp(appid, options, fn, err) {
      // ajax on that:
      var itemjson = {};
      var apppath = '/mirror/' + appid + '/app.json';
      $.ajax({
        type: 'GET',
        url: apppath,
        dataType: 'json',
        beforeSend: function(xhr) {},
        success: function(appjson) {
          var iconurl = '/static/images/icon.png';
          if (appjson.icon) {
              iconurl = '/mirror/' + appid + '/' + appjson.icon;
          }

          itemjson.icon = iconurl;
          itemjson.url = appjson.url;
          itemjson.appid = appid;
          itemjson.title = appjson.title;
          itemjson.editable = (appjson.owner === my.items.username || appjson.writers.indexOf(my.items.username) >= 0);
          itemjson.app = appjson;
          itemjson.editorurl = "http://editor.pageforest.com/#" + appid;
          if (options && options.staple) {
            itemjson.staple = true;
          }

          // itemjson: {<appid>: {icon: '', url: '', title: ''}
          my.items.create(appid, itemjson, function() {
            if (fn) {
              fn(appid, itemjson);
            }
          }, err);
        },
        error: function(request, textStatus, errorThrown) {
          var exception = {datasetname: 'my.pageforest', status: request.status, message: request.statusText, url: apppath, method: "read", kind: textStatus};
          exception.nested = {request: request, status: textStatus, exception: errorThrown};
          if (err) {
            err(exception);
          }
        }
      });
    };

    // reference: http://code.google.com/p/pageforest/source/browse/appengine/auth/middleware.py::referer_is_trusted
    function check(allowed, referer) {
      var i, len;
      for (i=0, len=allowed.length; i<len; i++) {
         var prefix = allowed[i];
         if (Strings.startsWith(referer, prefix)
             || Strings.startsWith(referer.replace('http://', 'https://'), prefix)) {
           return true;
         }
      }
      return false;
    }

    function checkReferers(referer, fn, err) {
      var appid = my.items.appid;
      if (!referers) {
        // ajax on that:
        var apppath = '/mirror/' + appid + '/app.json';
        $.ajax({
          type: 'GET',
          url: apppath,
          dataType: 'json',
          beforeSend: function(xhr) {},
          success: function(appjson) {
            referers = appjson.referers;
            if (check(referers, referer)) {
              fn();
            } else {
              err();
            }
          },
          error: function(request, textStatus, errorThrown) {
            var exception = {datasetname: 'my.pageforest', status: request.status, message: request.statusText, url: apppath, method: "read", kind: textStatus};
            exception.nested = {request: request, status: textStatus, exception: errorThrown};
            err();
          },
          async: false
        });
      } else {
        if (check(referers, referer)) {
          fn();
        } else {
          err();
        }
      }
    }

    var actions = {
      addApp: function(event, info) {
        var $target = $(this.el || this);
        if (info.search && info.search.installapp) {
          checkReferers(info.referer, function() {
            addApp(info.search.installapp);
          }, function() {
            console.error("referer doesn't pass.");
          });
        }
      },
      removeApp: function(event) {
        var $target = $(this.el || this);
        var appid = $target.parents("li").attr("data-launcheritemid");
        if (appid) {
          my.items.remove(appid, function() {
            if (fn) {
              fn(appid, itemjson);
            }
          }, function() {
            console.warn("error on item removed.");
          });
        }
      },
      enterEditMode: function(event) {
        var $target = $(this.el || this); // support both gt() and $()
        $target.parents("ul.grid").addClass("editmode");
      },
      exitEditMode: function(event) {
        var $target = $(this.el || this); // support both gt() and $()
        $("#z-launcherpane ul.grid.editmode").removeClass("editmode");
      }
    }

    // events
    $("#z-launcherpane").live("pagein", function() {
      caller = this;
      args = Array.prototype.slice.call(arguments);
      documentreadysignal.bind(function() {
        actions.addApp.apply(caller, args);
      });
    });

    documentreadysignal.bind(function() {
      $("#jqt").removeClass("initstate");
      $("#jqt").removeClass("nouserstate");
    });
    my.loggedout.push(function() {
      if (!loggedin) {
        $("#jqt").removeClass("initstate");
        $("#jqt").addClass("nouserstate");
      } else {
        // refresh
        window.location.reload();
      }
    });

    $(document).ready(function() {

      gt('#jqt > * ul.grid:not(.editmode) li').on('taphold', actions.enterEditMode);

      gt(document).on('doubletap', actions.exitEditMode);

    });

    // client.appid
    my.items.handler = {
      added: function(event) {
        var $newitem = $("#launcheritem-template").tmpl(event.item);
        $("#z-launcherpane ul").append($newitem);

        gt($newitem[0]).on('taphold', actions.enterEditMode);

        var $deleteicon = $newitem.find(".deleteicon");
        gt($deleteicon[0]).on('tap', function(event) {
          var $target = $(this.el || this); // support both gt() and $()
          var $parent = $target.parents("ul.grid.editmode");
          if ($parent.length > 0) {
            if (!$target.hasClass("nodelete")) {
              if (confirm("Are you surey you want to delete \"" + $target.parents("li").find("a").attr("title") +"\"?")) {
                actions.removeApp.apply(this, arguments);
              }
            }
          }
        }, false);
        $deleteicon.bind("tap", false);

        var $editoricon = $newitem.find(".editoricon");
        gt($editoricon[0]).on('tap', function(event) {
          var $target = $(this.el || this); // support both gt() and $()
          var $parent = $target.parents("ul.grid.editmode");
          var href = $target.attr("href");
          if (href) {
            window.open(href);
            setTimeout(function() {
              $parent.removeClass("editmode");
            }, 500);
          }
        }, false);
        $editoricon.bind("tap", false);

        gt($newitem[0]).on('tap', function(event) {
          var $target = $(this.el || this); // support both gt() and $()
          if ($target.parents("ul.grid.editmode").length === 0) {
            var href = $target.find("a").attr("href");
            if (href) {
              window.open(href);
            } else {
              console.warn("Cannot located href.");
            }
          }
        }, {expire: 750});
        $newitem.bind("tap", false);
      },
      removed: function(event) {
        var appid = event.id;
        $("#jqt > * ul.grid li[data-launcheritemid=" + appid + "]").remove();
      },
      updated: function(event) {
      }
    };

    $(document).ready(function() {
      addApp('editor', {staple: true});
    });

  </script>

  <script id="launcheritemgroup-template" type="text/x-jquery-tmpl">
    <ul id="${id}" class="grid"></ul>
  </script>
  <script id="launcheritem-template" type="text/x-jquery-tmpl">
    <li data-launcheritemid="${appid}" class="{{if staple}} nodelete{{/if}} {{if editable}}{{else}} noeditor{{/if}}">
      <a href="${url}" target="_webapp" title="${title}"><div class="icon" style="background-image: url(${icon});"><div class="mask"></div></div></a>
      <div class="deleteicon">X</div><div class="editoricon" href="${editorurl}">E</div>
    </li>
  </script>
  </head>
  <body>
    <div id="jqt" class="initstate unfixed">
    <div id="z-launcherpane" class="pane form" section="aside">
      <ul class="grid">
      </ul>
      <div class="showoninit emboss">
          <div class="spinner animate" style="width: 26px; height: 26px; margin: -8px 0;">
              <div class="bar1"></div><div class="bar2"></div><div class="bar3"></div><div class="bar4"></div>
              <div class="bar5"></div><div class="bar6"></div><div class="bar7"></div><div class="bar8"></div>
              <div class="bar9"></div><div class="bar10"></div><div class="bar11"></div><div class="bar12"></div>
          </div>Loading</div>
      <div class="showonnouser emboss">Please sign in</div>
    </div>
    <div class="page">
    <!--
       Standard Google Analytics tracking.  This can be removed from your own app,
       or replaced with your own account id.
      -->

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2072869-7']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
            '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    </div> <!-- page -->
    </div>
  </body>
</html>
