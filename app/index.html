<!DOCTYPE html>
<html >
  <head>
  <title>Welcome to Pageforest</title>
  <link rel="icon" type="image/png" href="/images/icon.png" />
  <link rel="apple-touch-icon" href="/images/touch.png" />

  <link rel="stylesheet" type="text/css" href="/lib/beta/css/client.css" />
  <style type="text/css" media="screen">@import "./jslib/jqtouch/jqtouch/jqtouch.css";</style>
  <style type="text/css" media="screen">@import "./jslib/jqtouch/themes/apple/theme.css";</style>
  <style type="text/css" media="screen">
    html, body {
       min-height: 100%;
    }

    body {
       -webkit-box-shadow: inset 1px 1px 10px rgba(127, 127, 127, 0.75);
       background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #AAA), color-stop(0.5, #999), color-stop(0.5, #999), color-stop(1, #666));
       background-image: -moz-linear-gradient(top, #AAA, #999 50%, #999 50%, #666);
       background-repeat: repeat-x;
       background-color: darkgrey;
    }

    #jqt > div#z-launcherpane, #jqt > form, #jqt > div {
       background-image: none;
       background-color: transparent;
    }

    #jqt > #z-launcherpane ul.grid {
       display: block;
       background-image: none;
       background-colo: transparent;
    }

    #jqt > #z-launcherpane ul.grid li {
       display: block;
       float: left;
    }
    #jqt > #z-launcherpane ul.grid li > a {
      display: block;
    }

    #jqt > #z-launcherpane ul.grid li .icon {
       background-color: #EEE;
    }

    @media only screen and (min-device-width: 768px) {
      #jqt > #z-launcherpane ul.grid li .icon {
         width: 64px;
         height: 64px;
      }
      #jqt > #z-launcherpane ul.grid li {
         margin: 30px;
      }
      #jqt > #z-launcherpane ul.grid li .icon .mask {
         background-image: -webkit-gradient(radial, 50% -58%, 35, 50% -35%, 190, from(rgba(255, 255, 255, 0.347656)), color-stop(0.03, rgba(255, 255, 255, 0.296875)), color-stop(0.22, rgba(239, 239, 239, 0)), color-stop(0.22, rgba(31, 31, 31, 0.199219)), color-stop(0.35, rgba(127, 127, 127, 0.0976563)), color-stop(0.38, rgba(239, 239, 239, 0.0976563)), to(rgba(255, 255, 255, 0)));
      }
    }

    #jqt:not(.initstate) .showoninit {
       display: none;
    }

    #jqt:not(.nouserstate) .showonnouser {
       display: none;
    }

    #pfSave,
    .nonpage,
    .hidden,
    .hidden > * {
       display: none;
    }

    #jqt .emboss {
      display: block; position: relative;
      -webkit-box-sizing: border-box;
      width: 100%; line-height: 20px;
      padding: 15px; padding-top: 20% !important;
      border-top: 1px solid rgba(76, 86, 108, .3);
      color: rgb(76, 76, 76);
      font-size: 16px; font-weight: bold; text-shadow: rgba(255,255,255,.8) 0 1px 0;
      text-align: center;
    }

    .buttonbar {
      position: fixed;
      top: 0; left: 0;
      height: 35px;
      -webkit-border-radius: 0 0 6px 6px; -moz-border-radius: 0 0 6px 6px;
      background-image: -webkit-gradient(linear, left top, left bottom,
        from(#EEFDE9), color-stop(0.05, #EEFDE9), color-stop(0.5, #BAF2A8), color-stop(0.5, #B3E8A0), to(#AAEE95));
      background-image: -moz-linear-gradient(top, #EEFDE9, #E4FBDD 5%, #BAF2A8 50%, #B3E8A0 50%, #AAEE95);
      font-family: Verdana, Arial, san-serif;
      font-size: 14px;
      margin-left: 16px;
      padding: 0 5px;
      z-index: 2;
    }

    .buttonbar span {
      box-sizing: border-box;
      margin: 4px;
      line-height: 27px;
      float: left;
      color: #464646;
    }

    .buttonbar span:hover, .buttonbar span:active {
      color: #000;
      background-color: #D2E6B3;
      cursor: pointer;
    }

    body:not(.editmode) .buttonbar {
      display: none;
    }
  </style>

  <!--
     These scripts provide access to the standard Client library
     for Pageforest apps.  jQuery and JSON, are also required
     by the Client library.

     Note that the "beta" versions of the library are used.  These
     are the most up to date versions.  You can change "beta" to
     "0.6" if you want the latest frozen version of the libraries.

     API reference: http://code.google.com/p/pageforest/wiki/ClientLibrary
    -->

  <script src="/lib/beta/js/pf-client.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/lib/date.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/lib/json2.js" type="text/javascript" charset="utf-8"></script>
  <script src="./jslib/lib/jquery.jsonp-2.1.4.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="./jslib/lib/jquery.tmpl.min.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/beedesk/utilities.js" type="application/x-javascript" charset="utf-8"></script>

  <script src="./jslib/jqtouch/jqtouch/jqtouch.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/jqtouch/extensions/iscroll/iscroll.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/touchlayer/src/gestures.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/beedesk/jqt.js" type="application/x-javascript" charset="utf-8"></script>
  <script src="./jslib/lib/jquery.quicksand.js" type="application/x-javascript" charset="utf-8"></script>

  <!-- The scratch application code is in main.js -->
  <script src="main.js" type="text/javascript"></script>

  <script type="text/javascript">
    var my = namespace.lookup("com.pageforest.my");

    // Call the onReady function of the application when the page is loaded.
    $(document).ready(my.onReady);

    // If user has logged in and then logoff, we refresh the page to avoid any
    // leftover data from previous session.
    var loggedin;
    my.loggedin.push(function() {
      loggedin = true;
    });
    my.loggedout.push(function() {
      if (loggedin) window.location.reload();
    });

    // -- Add Application Logic
    // Add application should wait until setDoc() is first called
    var documentreadysignal = Threads.latchbinder();
    my.documentready.push(documentreadysignal.latch);
    function addApp(appid, options, fn, err) {
      // ajax on that:
      var itemjson = {};
      var apppath = '/mirror/' + appid + '/app.json';
      $.ajax({
        type: 'GET',
        url: apppath,
        dataType: 'json',
        beforeSend: function(xhr) {},
        success: function(appjson) {
          var iconurl = '/static/images/icon.png';
          if (appjson.icon) {
              iconurl = '/mirror/' + appid + '/' + appjson.icon;
          }

          itemjson.icon = iconurl;
          itemjson.url = appjson.url;
          itemjson.appid = appid;
          itemjson.title = appjson.title;
          itemjson.editable = (appjson.owner === my.items.username || appjson.writers.indexOf(my.items.username) >= 0);
          itemjson.app = appjson;
          itemjson.editorurl = "http://editor.pageforest.com/#" + appid;

          if (options && options.staple) {
            itemjson.staple = true;
          }

          // itemjson: {<appid>: {icon: '', url: '', title: ''}
          my.items.create(appid, itemjson, function() {
            if (fn) {
              fn(appid, itemjson);
            }
          }, err);
        },
        error: function(request, textStatus, errorThrown) {
          var exception = {datasetname: 'my.pageforest', status: request.status, message: request.statusText, url: apppath, method: "read", kind: textStatus};
          exception.nested = {request: request, status: textStatus, exception: errorThrown};
          if (err) {
            err(exception);
          }
        }
      });
    };

    // reference: http://code.google.com/p/pageforest/source/browse/appengine/auth/middleware.py::referer_is_trusted
    var referers;
    function check(allowed, referer) {
      var i, len;
      for (i=0, len=allowed.length; i<len; i++) {
         var prefix = allowed[i];
         if (Strings.startsWith(referer, prefix)
             || Strings.startsWith(referer.replace('http://', 'https://'), prefix)) {
           return true;
         }
      }
      return false;
    }
    function checkReferers(referer, fn, err) {
      var appid = my.items.appid;
      if (!referers) {
        // ajax on that:
        var apppath = '/mirror/' + appid + '/app.json';
        $.ajax({
          type: 'GET', url: apppath, dataType: 'json', async: false,
          success: function(appjson) {
            referers = appjson.referers;
            if (check(referers, referer)) {
              fn();
            } else {
              err();
            }
          },
          error: function(request, textStatus, errorThrown) {
            err();
          }
        });
      } else {
        if (check(referers, referer)) {
          fn();
        } else {
          err();
        }
      } // these method can look much simpler if we use library such as "Promise".
    }
    // --/Add Application Logic

    // Manage display to indicate state
    documentreadysignal.bind(function() {
      $("#jqt").removeClass("initstate");
      $("#jqt").removeClass("nouserstate");
    });
    my.loggedout.push(function() {
      if (!loggedin) {
        $("#jqt").removeClass("initstate");
        $("#jqt").addClass("nouserstate");
      }
    });

    // Optional: Use code to ensure user always has our icons
    $(document).ready(function() {
      addApp('editor', {staple: true});
    });

    // Actions
    var actions = {
      addApp: function(event, info) {
        var $target = $(this.el || this);
        if (info.search && info.search.installapp) {
          checkReferers(info.referer, function() {
            addApp(info.search.installapp);
          }, function() {
            console.error("referer doesn't pass.");
          });
        }
      },
      removeApp: function(event) {
        var $target = $(this.el || this);
        var appid = $target.parents("li").attr("data-launcheritemid");
        if (appid) {
          my.items.remove(appid, function() {
            if (fn) {
              fn(appid, itemjson);
            }
          }, function() {
            console.warn("error on item removed.");
          });
        }
      },
      enterEditMode: function() {
        console.warn("entering edit mode.");
        $("ul#appgrid").addClass("editmode");
        $('body').addClass("editmode");
      },
      exitEditMode: function() {
        $("ul#appgrid.editmode").removeClass("editmode");
        $('body').removeClass("editmode");
      }
    }

    // Events
    $("#z-launcherpane").live("pagein", function() {
      caller = this;
      args = Array.prototype.slice.call(arguments);
      documentreadysignal.bind(function() {
        actions.addApp.apply(caller, args);
      });
    });

    $(document).ready(function() {
      gt(document).on('doubletap', actions.exitEditMode);
      $("#exitedit").live("click", actions.exitEditMode, false);
    });

    function prepItem(newitem) {
      var $newitem = $(newitem);
      gt(newitem).on('taphold', actions.enterEditMode);

      var $deleteicon = $newitem.find(".deleteicon");
      gt($deleteicon[0]).on('tap', function(event) {
        var $target = $(this.el || this); // support both gt() and $()
        var $parent = $target.parents("ul.grid.editmode");
        if ($parent.length > 0) {
          if (!$target.hasClass("nodelete")) {
            if (confirm("Are you surey you want to delete \"" + $target.parents("li").find("a").attr("title") +"\"?")) {
              actions.removeApp.apply(this, arguments);
            }
          }
        }
      }, false);
      $deleteicon.bind("tap", false);

      var $editoricon = $newitem.find(".editoricon");
      gt($editoricon[0]).on('tap', function(event) {
        var $target = $(this.el || this); // support both gt() and $()
        var $parent = $target.parents("ul.grid.editmode");
        var href = $target.attr("href");
        var target = $target.attr("target");
        if (href) {
          window.open(href, target);
          setTimeout(function() {
            actions.exitEditMode();
          }, 500);
        }
      }, false);
      $editoricon.bind("tap", false);

      gt(newitem).on('tap', function(event) {
        var $target = $(this.el || this); // support both gt() and $()
        if ($target.parents("ul.grid.editmode").length === 0) {
          var href = $target.find("a").attr("href");
          var target = $target.attr("target");
          if (href) {
            window.open(href, "_blank");
          } else {
            console.warn("Cannot located href.");
          }
        }
      }, {expire: 750});
      $newitem.bind("tap", false);
    }

    // Special queue mechanism to handle add/remove animation.
    // It queues up action if animation is in progress.
    var quicksandQueue = new function() {
      // @TODO generalize this function into generic utility
      var list;
      function launch(pre, fn) {
        var i, len;
        if (list.length > 0) {
          pre();
          for (var i=0, len=list.length; i<len; i++) {
            list[i]();
          }
          list = [];
          $("#appgrid").quicksand($("ul#replacement > li"), function() {
            launch(pre, fn);
          });
        } else {
          fn();
          list = undefined;
        }
      };
      function tickle() {
        if (list === undefined) {
          list = [];
          setTimeout(function() {
            // launch quicksand
            launch(function() {
              // prep a replacement section
              $("ul#replacement").children().remove();
              $("ul#appgrid > li").each(function(i, item) {
                $(item).clone().appendTo($("ul#replacement"));
              });
            }, function() {
              $("ul#appgrid > li").each(function(i, item) {
                prepItem(item);
              });
            });
          }, 100);
        }
      };
      function queue(fn) {
        tickle();
        list.push(fn);
      };
      return {queue: queue};
    }

    // Items handler listens to CRUD events from model
    my.items.handler = {
      added: function(event) {
        console.warn("added (" + event.id + "): " + event.after);
        function addItem() {
          var $newitem = $("#launcheritem-template").tmpl(event.item);
          if (event.after === undefined) {
            $("ul#replacement").prepend($newitem);
          } else {
            var $leader = $("ul#replacement").find("li[data-launcheritemid=" + event.after + "]");
            if ($leader.length > 0) {
              $leader.after($newitem);
            } else {
              console.error("Could not find peer, '" + event.after + "'");
              $("ul#replacement").append($newitem);
            }
          }
        };
        quicksandQueue.queue(addItem);
      },
      removed: function(event) {
        console.warn("remvoed (" + event.id + "): " + event.after);
        function removeItem() {
          var appid = event.id;
          $("ul#replacement > li[data-launcheritemid=" + appid + "]").remove();
        }
        quicksandQueue.queue(removeItem);
      },
      updated: function(event) {
        console.warn("updated: (" + event.id + "): " + event.after);
      }
    };
  </script>

  <script id="launcheritemgroup-template" type="text/x-jquery-tmpl">
    <ul id="${id}" class="grid"></ul>
  </script>
  <script id="launcheritem-template" type="text/x-jquery-tmpl">
    <li data-id="${appid}" data-launcheritemid="${appid}" class="{{if staple}} nodelete{{/if}} {{if editable}}{{else}} noeditor{{/if}}">
      <a href="${url}" target="_blank" title="${title}"><div class="icon" style="background-image: url(${icon});"><div class="mask"></div></div></a>
      <div class="deleteicon">X</div><div class="editoricon" href="${editorurl}">E</div>
    </li>
  </script>
  </head>
  <body>
    <div id="jqt" class="initstate unfixed">
    <div id="z-launcherpane" class="pane form" section="aside">
      <ul id="appgrid" class="grid">
      </ul>
      <div class="showoninit emboss">
          <div class="spinner animate" style="width: 26px; height: 26px; margin: -8px 0;">
              <div class="bar1"></div><div class="bar2"></div><div class="bar3"></div><div class="bar4"></div>
              <div class="bar5"></div><div class="bar6"></div><div class="bar7"></div><div class="bar8"></div>
              <div class="bar9"></div><div class="bar10"></div><div class="bar11"></div><div class="bar12"></div>
          </div>Loading</div>
      <div class="showonnouser emboss">Please sign in</div>
    </div>
    </div>
    <div>
      <ul class="hidden" id="replacement">
        <li data-id="beedesk-test" data-launcheritemid="beedesk-test" class=" "><a href="http://beedesk-test.pageforest.com/" target="_blank" title="BeeDesk"><div class="icon" style="background-image: url(/mirror/beedesk-test/images/BeeDesk_final_72px.png);"><div class="mask"></div></div></a><div class="deleteicon">X</div><div class="editoricon" href="http://editor.pageforest.com/#beedesk-test">E</div>     </li>
        <li data-id="editor" data-launcheritemid="editor" class=" nodelete  noeditor">       <a href="http://editor.pageforest.com/" target="_blank" title="Pageforest Application Editor"><div class="icon" style="background-image: url(/mirror/editor/images/icon.png);"><div class="mask"></div></div></a>       <div class="deleteicon">X</div><div class="editoricon" href="http://editor.pageforest.com/#editor">E</div>     </li>
        <li data-id="pawnpwn" data-launcheritemid="pawnpwn" class="  noeditor">       <a href="http://pawnpwn.pageforest.com/" target="_blank" title="Pawn Pwn"><div class="icon" style="background-image: url(/mirror/pawnpwn/images/icon.png);"><div class="mask"></div></div></a>       <div class="deleteicon">X</div><div class="editoricon" href="http://editor.pageforest.com/#pawnpwn">E</div>     </li>
        <li data-id="wiki" data-launcheritemid="wiki" class="  noeditor"><a href="http://wiki.pageforest.com/" target="_blank" title="Pageforest Wiki"><div class="icon" style="background-image: url(/mirror/wiki/images/icon.png);"><div class="mask"></div></div></a>       <div class="deleteicon">X</div><div class="editoricon" href="http://editor.pageforest.com/#wiki">E</div></li>
      </ul>
    </div>
    <div class="nonpage">
      <!--
         Standard Google Analytics tracking.  This can be removed from your own app,
         or replaced with your own account id.
        -->
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-2072869-7']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') +
              '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
    </div> <!-- page -->
    <div class="buttonbar">
      <span id="exitedit">Done</span>
    </div>
  </body>
</html>
